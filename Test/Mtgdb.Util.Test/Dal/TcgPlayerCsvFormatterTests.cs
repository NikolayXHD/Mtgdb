using System.Linq;
using System.Text.RegularExpressions;
using Mtgdb.Gui;
using Mtgdb.Test;
using NUnit.Framework;

namespace Mtgdb.Util
{
	[TestFixture]
	public class TcgPlayerCsvFormatterTests: TestsBase
	{
		[SetUp]
		public void Setup()
		{
			LoadCards();
		}

		[Test]
		public void TcgPlayerCsvFormatter_matches_cards([ValueSource(nameof(_tcgCsvCards))] string cardRow)
		{
			var deckFormatter = new TcgCsvDeckFormatter(Repo);
			// Test file to Parse.  File generated by TCG Player mobile card scanning app:
			string csvContent = TcgCsvHeader + TcgCsvRowDelimiter + cardRow;
			Ui.Deck deck = deckFormatter.ImportDeck(csvContent);
			Assert.That(deck.MainDeck.Order.Count, Is.EqualTo(1));
		}

		[Test]
		public void TcgPlayerCsvFormatter_matches_multiple_cards([Values(2, 5)] int rowsCount)
		{
			var deckFormatter = new TcgCsvDeckFormatter(Repo);
			// Test file to Parse.  File generated by TCG Player mobile card scanning app:
			string csvContent = TcgCsvHeader + TcgCsvRowDelimiter + string.Join(TcgCsvRowDelimiter, _tcgCsvCards.Take(rowsCount));
			Ui.Deck deck = deckFormatter.ImportDeck(csvContent);
			Assert.That(deck.MainDeck.Order.Count, Is.EqualTo(rowsCount));
		}

		[Test]
		public void TcgPlayerCsvFormatter_matches_set()
		{
			var deckFormatter = new TcgCsvDeckFormatter(Repo);
			string csvContent = TcgCsvHeader + TcgCsvRowDelimiter + _tcgCsvCards[0];
			Ui.Deck deck = deckFormatter.ImportDeck(csvContent);
			var matchedCard = Repo.CardsById[deck.MainDeck.Order[0]];
			Assert.That(matchedCard.SetCode, Is.EqualTo("ELD"));
		}

		[Test]
		public void TcgPlayerCsvFormatter_parses_count([Values(1, 2, 3, 4, 20)] int cardCount)
		{
			var deckFormatter = new TcgCsvDeckFormatter(Repo);
			string csvContent = TcgCsvHeader + TcgCsvRowDelimiter + Regex.Replace(_tcgCsvCards[0], @"^\d+(?=,)", cardCount.ToString());
			Ui.Deck deck = deckFormatter.ImportDeck(csvContent);
			Assert.That(deck.MainDeck.Count.Values.Single(), Is.EqualTo(cardCount));
		}

		private const string TcgCsvRowDelimiter = "\n";

		// Csv header from a file generated by TCG Player mobile card scanning app:
		private const string TcgCsvHeader = "Quantity,Name,Simple Name,Set,Card Number,Set Code,Printing,Condition,Language,Rarity,Product ID,SKU";

		// Csv rows from a file generated by TCG Player mobile card scanning app:
		private static readonly string[] _tcgCsvCards =
		{
			"1,Castle Locthwain (Extended Art),Castle Locthwain,Throne of Eldraine,389,ELD,Foil,Near Mint,English,Rare,199389,4206363",
			"1,Castle Garenbrig (Extended Art),Castle Garenbrig,Throne of Eldraine,388,ELD,Normal,Near Mint,English,Rare,199289,4203160",
			"1,Irencrag Feat (Extended Art),Irencrag Feat,Throne of Eldraine,362,ELD,Normal,Near Mint,English,Rare,199245,4201268",
			"1,Worthy Knight,Worthy Knight,Throne of Eldraine,36,ELD,Foil,Near Mint,English,Rare,198811,4187423",
			"1,Faerie Guidemother (Showcase),Faerie Guidemother,Throne of Eldraine,274,ELD,Foil,Near Mint,English,Common,198977,4193004",
			"1,Rimrock Knight (Showcase),Rimrock Knight,Throne of Eldraine,294,ELD,Normal,Near Mint,English,Common,199502,4211949",
			"1,Giant Killer (Showcase),Giant Killer,Throne of Eldraine,275,ELD,Normal,Near Mint,English,Rare,198829,4187908",
			"1,Order of Midnight (Showcase),Order of Midnight,Throne of Eldraine,288,ELD,Normal,Near Mint,English,Uncommon,198406,4177465",
			"1,Epic Downfall,Epic Downfall,Throne of Eldraine,85,ELD,Foil,Near Mint,English,Uncommon,198972,4192454",
			"1,Golden Egg,Golden Egg,Throne of Eldraine,220,ELD,Foil,Near Mint,English,Common,198395,4176350",
			"1,Witching Well,Witching Well,Throne of Eldraine,74,ELD,Foil,Near Mint,English,Common,198389,4175690",
			"1,Reaper of Night (Showcase),Reaper of Night,Throne of Eldraine,289,ELD,Foil,Near Mint,English,Common,199500,4211734",
			"1,Crashing Drawbridge,Crashing Drawbridge,Throne of Eldraine,217,ELD,Foil,Near Mint,English,Common,199543,4216319",
			"1,Dwarven Mine,Dwarven Mine,Throne of Eldraine,243,ELD,Foil,Near Mint,English,Common,199542,4216209",
			"1,Merchant of the Vale,Merchant of the Vale,Throne of Eldraine,131,ELD,Foil,Near Mint,English,Common,198998,4193964",
			"1,Banish into Fable,Banish into Fable,Throne of Eldraine,325,ELD,Normal,Near Mint,English,Rare,198442,4179340",
			"1,Corridor Monitor,Corridor Monitor,Throne of Eldraine,41,ELD,Foil,Near Mint,English,Common,198558,4180610",
			"1,Hypnotic Sprite,Hypnotic Sprite,Throne of Eldraine,49,ELD,Foil,Near Mint,English,Uncommon,198792,4186973",
			"1,Improbable Alliance,Improbable Alliance,Throne of Eldraine,193,ELD,Foil,Near Mint,English,Uncommon,199403,4206743",
			"1,Tuinvale Treefolk (Showcase),Tuinvale Treefolk,Throne of Eldraine,301,ELD,Normal,Near Mint,English,Common,199253,4201423",
			"1,Beloved Princess,Beloved Princess,Throne of Eldraine,7,ELD,Foil,Near Mint,English,Common,198891,4190765",
			"1,Ferocity of the Wilds,Ferocity of the Wilds,Throne of Eldraine,123,ELD,Foil,Near Mint,English,Uncommon,199095,4198390",
			"1,Lonesome Unicorn (Showcase),Lonesome Unicorn,Throne of Eldraine,276,ELD,Normal,Near Mint,English,Common,199218,4200812",
			"1,Rally for the Throne,Rally for the Throne,Throne of Eldraine,25,ELD,Foil,Near Mint,English,Uncommon,199210,4200232",
			"1,Wind-Scarred Crag,Wind-Scarred Crag,Throne of Eldraine,308,ELD,Normal,Near Mint,English,Common,198728,4184422",
			"1,Giant's Skewer,Giant's Skewer,Throne of Eldraine,91,ELD,Foil,Near Mint,English,Common,199341,4204735",
			"1,Fierce Witchstalker,Fierce Witchstalker,Throne of Eldraine,154,ELD,Foil,Near Mint,English,Common,199022,4196170",
			"1,Festive Funeral,Festive Funeral,Throne of Eldraine,87,ELD,Foil,Near Mint,English,Common,199414,4207848",
			"1,Knight of the Keep,Knight of the Keep,Throne of Eldraine,19,ELD,Foil,Near Mint,English,Common,199008,4195184",
			"1,Castle Locthwain,Castle Locthwain,Promo Pack: Throne of Eldraine,241p,PPELD,Normal,Near Mint,English,Rare,200387,4230426",
			"1,Castle Locthwain,Castle Locthwain,Prerelease Cards,241s,PRE,Foil,Near Mint,English,Rare,199936,4222012",
			"1,Castle Locthwain (Extended Art),Castle Locthwain,Throne of Eldraine,389,ELD,Foil,Near Mint,English,Rare,199389,4206363",
			"1,Castle Locthwain,Castle Locthwain,Throne of Eldraine,241,ELD,Foil,Near Mint,English,Rare,199388,4206253",
			"1,Castle Locthwain (Extended Art),Castle Locthwain,Throne of Eldraine,389,ELD,Normal,Near Mint,English,Rare,199389,4206358",
			"1,Castle Locthwain,Castle Locthwain,Throne of Eldraine,241,ELD,Normal,Near Mint,English,Rare,199388,4206248",
		};
	}
}
